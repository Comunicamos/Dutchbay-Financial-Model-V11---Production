
```python
#!/usr/bin/env python3
"""
Dutch Bay 150MW Wind Farm Financial Model - CLI Interface

Comprehensive command-line interface for running financial analysis scenarios:
- Baseline: Single scenario financial projection
- Monte Carlo: 1,000+ stochastic scenario simulations
- Sensitivity: One-at-a-time parameter stress testing (tornado analysis)
- Optimize: Multi-objective optimization for capital structure
- Validate: Type checking, linting, and unit tests
- Export: Multi-format data export (CSV/JSON/Excel)

Usage Examples:
    python dutchbay_cli.py --mode=baseline
    python dutchbay_cli.py --mode=monte-carlo --iterations=1000
    python dutchbay_cli.py --mode=sensitivity
    python dutchbay_cli.py --mode=optimize
    python dutchbay_cli.py --mode=validate
    python dutchbay_cli.py --mode=export --format=xlsx

Author: Financial Modeling Team
Date: November 7, 2025
Version: V12 (Production-Grade)
\"\"\"\n\nimport argparse\nimport sys\nimport os\nimport json\nfrom typing import Optional, Dict, Any\nfrom pathlib import Path\n\nsys.path.insert(0, str(Path(__file__).parent / 'scripts'))\n\nfrom dutchbay_model_v12 import (\n    build_financial_model,\n    create_default_parameters,\n    create_default_debt_structure,\n    FinancialResults,\n)\nfrom monte_carlo import run_monte_carlo\nfrom sensitivity import run_sensitivity_analysis\nfrom optimization import optimize_capital_structure\n\n\n# ============================================================================\n# LOGGING AND OUTPUT UTILITIES\n# ============================================================================\n\ndef print_header(title: str) -> None:\n    \"\"\"Print formatted section header.\"\"\"\n    print(\"\\n\" + \"=\"*80)\n    print(title.center(80))\n    print(\"=\"*80)\n\n\ndef print_section(title: str) -> None:\n    \"\"\"Print formatted subsection header.\"\"\"\n    print(f\"\\n--- {title} ---\")\n\n\ndef print_success(message: str) -> None:\n    \"\"\"Print success message with checkmark.\"\"\"\n    print(f\"✓ {message}\")\n\n\ndef print_error(message: str) -> None:\n    \"\"\"Print error message with X mark.\"\"\"\n    print(f\"✗ {message}\", file=sys.stderr)\n\n\n# ============================================================================\n# MODE HANDLER FUNCTIONS\n# ============================================================================\n\ndef run_baseline(args: argparse.Namespace) -> None:\n    \"\"\"\n    Execute baseline scenario analysis.\n    \n    Runs the Dutch Bay financial model with default parameters and\n    exports the complete 20-year cash flow projection.\n    \n    Args:\n        args: Parsed command-line arguments with output_dir\n    \n    Returns:\n        None (outputs written to CSV)\n    \"\"\"\n    print_header(\"BASELINE SCENARIO ANALYSIS\")\n    print_section(\"Building Financial Model\")\n    \n    try:\n        results: FinancialResults = build_financial_model()\n        \n        print_section(\"Financial Metrics\")\n        print(f\"Equity IRR:              {results.equity_irr*100:.2f}%\")\n        print(f\"Project IRR:             {results.project_irr*100:.2f}%\")\n        print(f\"NPV @ 12% Discount:      ${results.npv_12pct:.2f}M\")\n        print(f\"Year 1 DSCR:             {results.year1_dscr:.2f}x\")\n        print(f\"Min DSCR (all years):    {results.min_dscr:.2f}x\")\n        print(f\"Avg DSCR:                {results.avg_dscr:.2f}x\")\n        \n        output_path = os.path.join(args.output_dir, 'dutchbay_baseline_v12.csv')\n        results.annual_data.to_csv(output_path, index=False)\n        print_success(f\"Baseline results saved to {output_path}\")\n        \n    except Exception as e:\n        print_error(f\"Baseline execution failed: {str(e)}\")\n        raise\n\n\ndef run_monte_carlo_mode(args: argparse.Namespace) -> None:\n    \"\"\"\n    Execute Monte Carlo simulation.\n    \n    Generates multiple scenarios by randomly varying:\n    - Interest rates (USD/LKR): 6.5% - 9%\n    - Debt ratios: 50% - 80%\n    - FX depreciation: 3% - 5% annually\n    - Capacity factor: 38% - 42%\n    \n    Outputs distribution statistics and full scenario results.\n    \n    Args:\n        args: Parsed CLI args with iterations and output_dir\n    \n    Returns:\n        None (results written to CSV)\n    \"\"\"\n    print_header(f\"MONTE CARLO SIMULATION ({args.iterations} ITERATIONS)\")\n    print_section(\"Running Scenarios\")\n    \n    try:\n        mc_results = run_monte_carlo(args.iterations)\n        \n        print_section(\"Distribution Statistics\")\n        eq_irr_stats = {\n            'mean': mc_results['equity_irr'].mean(),\n            'median': mc_results['equity_irr'].median(),\n            'std': mc_results['equity_irr'].std(),\n            'p10': mc_results['equity_irr'].quantile(0.10),\n            'p50': mc_results['equity_irr'].quantile(0.50),\n            'p90': mc_results['equity_irr'].quantile(0.90),\n            'min': mc_results['equity_irr'].min(),\n            'max': mc_results['equity_irr'].max(),\n        }\n        \n        print(\"Equity IRR Distribution:\")\n        print(f\"  Mean:                  {eq_irr_stats['mean']*100:.2f}%\")\n        print(f\"  Median:                {eq_irr_stats['median']*100:.2f}%\")\n        print(f\"  Std Dev:               {eq_irr_stats['std']*100:.2f}%\")\n        print(f\"  P10 (downside):        {eq_irr_stats['p10']*100:.2f}%\")\n        print(f\"  P50 (midpoint):        {eq_irr_stats['p50']*100:.2f}%\")\n        print(f\"  P90 (upside):          {eq_irr_stats['p90']*100:.2f}%\")\n        print(f\"  Min:                   {eq_irr_stats['min']*100:.2f}%\")\n        print(f\"  Max:                   {eq_irr_stats['max']*100:.2f}%\")\n        \n        # Save results\n        output_path = os.path.join(args.output_dir, 'dutchbay_monte_carlo.csv')\n        mc_results.to_csv(output_path, index=False)\n        print_success(f\"MC scenarios saved to {output_path}\")\n        \n        # Save summary stats\n        stats_path = os.path.join(args.output_dir, 'dutchbay_mc_statistics.json')\n        stats_dict = {k: float(v) for k, v in eq_irr_stats.items()}\n        with open(stats_path, 'w') as f:\n            json.dump(stats_dict, f, indent=2)\n        print_success(f\"MC statistics saved to {stats_path}\")\n        \n    except Exception as e:\n        print_error(f\"Monte Carlo execution failed: {str(e)}\")\n        raise\n\n\ndef run_sensitivity_mode(args: argparse.Namespace) -> None:\n    \"\"\"\n    Execute sensitivity analysis (tornado chart).\n    \n    One-at-a-time parameter stress test across:\n    - Capacity Factor: ±5% (38% - 42%)\n    - OPEX: ±10% (USD 6.15 - 7.51/MWh)\n    - Interest Rates: +200 bps (USD 8.95%, LKR 9.5%)\n    - CAPEX: ±8% ($142.6M - $167.4M)\n    - FX Depreciation: -3% to -5%\n    \n    Args:\n        args: Parsed CLI args with output_dir\n    \n    Returns:\n        None (results written to CSV)\n    \"\"\"\n    print_header(\"SENSITIVITY ANALYSIS (TORNADO CHART)\")\n    print_section(\"Running Parameter Stress Tests\")\n    \n    try:\n        sens_results = run_sensitivity_analysis(args.output_dir)\n        \n        print_section(\"Sensitivity Results (Sorted by IRR Impact)\")\n        display_cols = ['parameter', 'stressed_value', 'delta_irr', 'delta_npv']\n        print(sens_results[display_cols].sort_values('delta_irr', ascending=False).to_string(index=False))\n        \n        output_path = os.path.join(args.output_dir, 'dutchbay_sensitivity.csv')\n        print_success(f\"Full sensitivity results saved to {output_path}\")\n        \n    except Exception as e:\n        print_error(f\"Sensitivity analysis failed: {str(e)}\")\n        raise\n\n\ndef run_optimize_mode(args: argparse.Namespace) -> None:\n    \"\"\"\n    Execute multi-objective capital structure optimization.\n    \n    Maximizes Equity IRR subject to:\n    - Equity IRR ≥ 15% (hard constraint)\n    - DSCR ≥ 1.3x (all years, hard constraint)\n    - Debt ratio: 50% - 80%\n    - USD/LKR split: 0% - 100%\n    - DFI debt: 0% - 20% of USD portion\n    \n    Uses SciPy SLSQP (Sequential Least Squares Programming) solver.\n    \n    Args:\n        args: Parsed CLI args with output_dir\n    \n    Returns:\n        None (results written to CSV and console)\n    \"\"\"\n    print_header(\"MULTI-OBJECTIVE OPTIMIZATION\")\n    print_section(\"Optimization Configuration\")\n    print(\"Objective:               Maximize Equity IRR\")\n    print(\"Constraints:\")\n    print(\"  - Equity IRR ≥ 15%\")\n    print(\"  - DSCR ≥ 1.3x (all years)\")\n    print(\"Variables:\")\n    print(\"  - Debt Ratio:          50% - 80%\")\n    print(\"  - USD/LKR Split:       0% - 100%\")\n    print(\"  - DFI Portion:         0% - 20% of USD\")\n    \n    print_section(\"Running Optimizer\")\n    \n    try:\n        opt_result = optimize_capital_structure(objective='equity_irr')\n        \n        print_section(\"OPTIMIZATION RESULTS\")\n        print(f\"Convergence:             {opt_result['convergence']}\")\n        print(f\"Solver Message:          {opt_result['message']}\")\n        \n        print_section(\"Optimal Capital Structure\")\n        print(f\"Debt Ratio:              {opt_result['optimal_debt_ratio']:.2%}\")\n        print(f\"USD Debt:                {opt_result['optimal_usd_pct']:.2%}\")\n        print(f\"DFI Debt:                {opt_result['optimal_dfi_pct']:.2%}\")\n        \n        print_section(\"Optimized Financial Metrics\")\n        print(f\"Equity IRR:              {opt_result['optimized_equity_irr']*100:.2f}%\")\n        print(f\"Project IRR:             {opt_result['optimized_project_irr']*100:.2f}%\")\n        print(f\"NPV @ 12%:               ${opt_result['optimized_npv']:.2f}M\")\n        print(f\"Min DSCR:                {opt_result['optimized_min_dscr']:.2f}x\")\n        \n        # Export optimized scenario\n        output_path = os.path.join(args.output_dir, 'dutchbay_optimized.csv')\n        opt_result['result'].annual_data.to_csv(output_path, index=False)\n        print_success(f\"Optimized scenario saved to {output_path}\")\n        \n    except Exception as e:\n        print_error(f\"Optimization failed: {str(e)}\")\n        raise\n\n\ndef run_validate_mode(args: argparse.Namespace) -> None:\n    \"\"\"\n    Execute validation suite: type checking, linting, tests.\n    \n    Runs:\n    1. pytest - Unit and integration tests\n    2. flake8 - PEP8 code style\n    3. pylint - Code quality and error detection\n    4. mypy - Static type checking (strict mode)\n    \n    Args:\n        args: Parsed CLI args\n    \n    Returns:\n        None (validation output to console)\n    \"\"\"\n    import subprocess\n    \n    print_header(\"VALIDATION SUITE\")\n    \n    validations = [\n        ('Pytest (Unit Tests)', ['pytest', 'tests/', '-v', '--tb=short']),\n        ('Flake8 (Code Style)', ['flake8', 'scripts/']),\n        ('Pylint (Code Quality)', ['pylint', 'scripts/dutchbay_model_v12.py']),\n        ('Mypy (Type Checking)', ['mypy', 'scripts/dutchbay_model_v12.py', '--strict']),\n    ]\n    \n    for name, cmd in validations:\n        print_section(name)\n        try:\n            result = subprocess.run(cmd, capture_output=False, check=False)\n            if result.returncode == 0:\n                print_success(f\"{name} passed\")\n            else:\n                print(f\"⚠ {name} completed with warnings\")\n        except FileNotFoundError:\n            print(f\"⚠ {name} tool not found. Install with: pip install {cmd[0]}\")\n\n\ndef run_export_mode(args: argparse.Namespace) -> None:\n    \"\"\"\n    Export all analysis results to specified format.\n    \n    Supports:\n    - CSV (default): Individual files per analysis\n    - JSON: Summary metrics and statistics\n    - XLSX: Multi-sheet Excel workbook (future)\n    \n    Args:\n        args: Parsed CLI args with format and output_dir\n    \n    Returns:\n        None (files written to output_dir)\n    \"\"\"\n    print_header(f\"EXPORTING RESULTS ({args.format.upper()})\")\n    \n    if args.format == 'csv':\n        print_section(\"CSV Export\")\n        baseline = build_financial_model()\n        baseline.annual_data.to_csv(\n            os.path.join(args.output_dir, 'export_baseline.csv'),\n            index=False\n        )\n        print_success(\"CSV export complete\")\n    \n    elif args.format == 'json':\n        print_section(\"JSON Export\")\n        baseline = build_financial_model()\n        export_data = {\n            'metadata': {'version': 'V12', 'date': '2025-11-07'},\n            'metrics': {\n                'equity_irr': baseline.equity_irr,\n                'project_irr': baseline.project_irr,\n                'npv_12pct': baseline.npv_12pct,\n                'min_dscr': baseline.min_dscr,\n            }\n        }\n        with open(os.path.join(args.output_dir, 'export_summary.json'), 'w') as f:\n            json.dump(export_data, f, indent=2)\n        print_success(\"JSON export complete\")\n    \n    elif args.format == 'xlsx':\n        print(\"⚠ XLSX export not yet implemented. Use CSV or JSON.\")\n\n\n# ============================================================================\n# MAIN CLI ENTRY POINT\n# ============================================================================\n\ndef main() -> None:\n    \"\"\"\n    Main CLI entry point. Parses arguments and routes to appropriate handler.\n    \"\"\"\n    parser = argparse.ArgumentParser(\n        description='Dutch Bay 150MW Wind Farm Financial Model V12 - CLI Interface',\n        epilog='For detailed usage, see README.md or docs/USAGE.md'\n    )\n    \n    parser.add_argument(\n        '--mode',\n        choices=['baseline', 'monte-carlo', 'sensitivity', 'optimize', 'validate', 'export'],\n        required=True,\n        help='Analysis mode to execute'\n    )\n    \n    parser.add_argument(\n        '--iterations',\n        type=int,\n        default=1000,\n        help='Monte Carlo iterations (default: 1000)'\n    )\n    \n    parser.add_argument(\n        '--output-dir',\n        type=str,\n        default='./outputs',\n        help='Output directory for results (default: ./outputs)'\n    )\n    \n    parser.add_argument(\n        '--format',\n        choices=['csv', 'json', 'xlsx'],\n        default='csv',\n        help='Export format (default: csv)'\n    )\n    \n    args = parser.parse_args()\n    \n    # Ensure output directory exists\n    os.makedirs(args.output_dir, exist_ok=True)\n    \n    # Route to appropriate mode handler\n    modes = {\n        'baseline': run_baseline,\n        'monte-carlo': run_monte_carlo_mode,\n        'sensitivity': run_sensitivity_mode,\n        'optimize': run_optimize_mode,\n        'validate': run_validate_mode,\n        'export': run_export_mode,\n    }\n    \n    try:\n        handler = modes[args.mode]\n        handler(args)\n        print(\"\\n✓ Analysis complete!\\n\")\n    except Exception as e:\n        print_error(f\"Fatal error: {str(e)}\")\n        sys.exit(1)\n\n\nif __name__ == \"__main__\":\n    main()\n```\n\n---\n\n## **Key Enhancements**\n\n1. **Full Docstrings**: Every function has comprehensive docstrings explaining purpose, parameters, and return values\n2. **Utility Functions**: Helper functions for formatted output (headers, sections, success/error messages)\n3. **Comprehensive Error Handling**: Try-except blocks with informative error messages\n4. **Mode Documentation**: Each mode function explains the parameters it varies and constraints it enforces\n5. **Output Organization**: Results are saved with descriptive filenames and summary statistics exported\n6. **Type Hints**: Function signatures include type annotations for clarity\n7. **CLI Argument Documentation**: All arguments have help text explaining their purpose and defaults\n\n---\n\n## **Integration Instructions**\n\n### Step 1: Back up existing CLI\n```bash\ncp /Users/aruna/Desktop/DutchBay_Financials_V11/dutchbay_cli.py dutchbay_cli_backup.py\n```\n\n### Step 2: Replace with enhanced version\nCopy the complete code above and save to:\n```\n/Users/aruna/Desktop/DutchBay_Financials_V11/dutchbay_cli.py\n```\n\n### Step 3: Test immediately\n```bash\ncd /Users/aruna/Desktop/DutchBay_Financials_V11/\npython dutchbay_cli.py --mode=baseline\n```\n\n---\n\n## **CLI Usage Examples**\n\n```bash\n# Baseline (20-year projection)\npython dutchbay_cli.py --mode=baseline\n\n# Monte Carlo (5,000 scenarios)\npython dutchbay_cli.py --mode=monte-carlo --iterations=5000\n\n# Sensitivity analysis\npython dutchbay_cli.py --mode=sensitivity\n\n# Capital structure optimization\npython dutchbay_cli.py --mode=optimize\n\n# Validation suite\npython dutchbay_cli.py --mode=validate\n\n# Export to JSON\npython dutchbay_cli.py --mode=export --format=json\n\n# Custom output directory\npython dutchbay_cli.py --mode=baseline --output-dir=/tmp/results\n```